<html>
	<head>
	<script type="text/javascript" src="mootools.js"></script>
	<script type="text/javascript" src="mimic.js"></script>
	<script>
		var username = null;
		var password = null;
			
		var sipgateCredentials = {
			"SipRegistrar": "sipgate.de",
			"NtpServer": "ntp.sipgate.net",
			"HttpServer": "www.live.sipgate.de",
			"SipOutboundProxy": "proxy.dev.sipgate.de",
			"XmppServer": "",
			"StunServer": "stun.sipgate.net",
			"SamuraiServer": "api.sipgate.net",
			"SimpleServer": ""
		};
	
		var recommendedIntervals = {
			"samurai.BalanceGet": 60,
			"samurai.RecommendedIntervalGet": 60,
			"samurai.EventSummaryGet": 60
		};
		
		var curBalance;
		
		function doOnLoad()
		{
			username = localStorage.getItem('username');
			password = localStorage.getItem('password');
			console.debug('username: ' + username + " & password: " + password);
			if(username != null && password != null)
			{
				login();
			}
		}
		
		function login(force)
		{
			if(force || username == null || password == null)
			{
			username = $('username').get('value');
			password = $('password').get('value');
			}
			
			console.debug('username: ' + username + " & password: " + password);
			//var msg = new XMLRPCMessage("samurai.ServerdataGet");
			
			localStorage.setItem('username', username);
			localStorage.setItem('password', password);
			
			var onSuccess = function(res) {
				if (res.StatusCode && res.StatusCode == 200) {
					getBalance();
					// getTosList();
					getRecommendedIntervals();

					$('notLoggedIn').addClass('view_template');
					$('loggedIn').removeClass('view_template');
					$('loggedIn').addEvent('click', function() { window.open('http://' + sipgateCredentials.HttpServer ); });

					console.log("SUCCESSFULLY LOGGED IN");
					
					sipgateCredentials = res;
				}
				// $('msg').set('text', JSON.encode(res));
			};
			
			_rpcCall("samurai.ServerdataGet", null, onSuccess);
		
		}
		
		function getRecommendedIntervals() {

			var onSuccess = function(res) {
				if (res.StatusCode && res.StatusCode == 200) {
					if (res.IntervalList.length > 0) {
						for (var i = 0; i < res.IntervalList.length; i++) {
							recommendedIntervals[res.IntervalList[i].MethodName] = res.IntervalList[i].RecommendedInterval;
						}
					}
				}
			};
				
			var params = {
				'MethodList': ["samurai.RecommendedIntervalGet", "samurai.BalanceGet", "samurai.EventSummaryGet"]
			};			
			
			_rpcCall("samurai.RecommendedIntervalGet", params, onSuccess);
		}
		
		function getBalance() {

			var onSuccess = function(res) {
				console.log('### getBalance. Result received.');
				
				if (res.StatusCode && res.StatusCode == 200) {
					var balance = res.CurrentBalance;
					var currency = balance.Currency;
					var balanceValueDouble = balance.TotalIncludingVat;
					
					var balanceValueString = balanceValueDouble;
					
					// dirty hack to localize floats:
					if (navigator.language == "de") {
						// german floats use "," as delimiter for mantissa:
						balanceValueString = balanceValueDouble.toFixed(2).toString();
						balanceValueString = balanceValueString.replace(/\./, ",");
					} else {
						balanceValueString = balanceValueDouble.toFixed(2).toString();
					}
					
					curBalance = [balanceValueString + " " + currency, balanceValueDouble];
					$('balance').set('text', curBalance[0]);
					
					if(curBalance[1] < 5.0) {
						$('balance').set('styles', {'color':'red'});
					}
				}
				
				/*
				if (_sgffx.getPref("extensions.sipgateffx.polling", "bool")) {
					// set update timer
					var delay = _sgffx.recommendedIntervals["samurai.BalanceGet"];
					
					_sgffx.getBalanceTimer.initWithCallback({
						notify: function(timer) {
							_sgffx.curBalance = null;
							_sgffx.getBalance();
						}
					}, delay * 1000, Components.interfaces.nsITimer.TYPE_ONE_SHOT);
					
					_sgffx.log("getBalance: polling enabled. set to " + delay + " seconds");
				}
				*/
			};		
			
			_rpcCall("samurai.BalanceGet", null, onSuccess);
		}		
		
		function _rpcCall(method, params, successCallback, failureCallback)
		{
			var msg = new XmlRpcRequest('', method);
			if(typeof params != 'undefined' && params != null)
			{
				msg.addParam(params);
			}
			var xml = msg.parseXML();
			console.log(xml);

			new Request({ url: 'http://' + encodeURIComponent(username) + ":" + encodeURIComponent(password) + '@samurai01.dev.sipgate.net/RPC2', 
						headers: {
							'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
							'Content-Type': 'text/xml; charset=UTF-8'
						},
						data: xml,
						onSuccess: function(resText, resXML) {
							var ourParsedResponse = new XmlRpcResponse(resXML).parseXML();
							if(typeof successCallback == 'function')
							{
								successCallback(ourParsedResponse);
							}
						},
						onFailure: function(xhr) {
							console.log("BAD" + xhr.status);
							if(typeof failureCallback == 'function')
							{
								failureCallback(xhr);
							}							
						},
						}).send();
		}
		
	</script>
	<style>
		.view_template {
			display: none;
			visibility: hidden;
		}
	</style>
	</head>
	<body onload="doOnLoad()">
		<div id="notLoggedIn">
			<img src="skin/icon_sipgate_inactive.gif" title="not logged in" />
			Username: <input id="username" type="text">  
			Password: <input id="password" type="password">
			<input type="button" id="login" value="Login" onclick="login(true)">
		</div>

		<div id="loggedIn" class="view_template toolstrip-button">
			<img src="skin/icon_sipgate_active.gif" title="sipgate"/>
			<span id="balance"></span>
		</div>
		<span id="msg"></span>
	</body>
</html>